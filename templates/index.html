{% extends "base.html" %}

{% block title %}Dashboard CAN 2025 - Statistiques & KPIs{% endblock %}

{% block content %}
<style>
    .table-custom {
        font-size: 0.95rem;
    }
    
    .table-custom thead tr {
        background: linear-gradient(135deg, rgba(255,215,0,0.2) 0%, rgba(0,107,63,0.2) 100%);
        border-bottom: 2px solid var(--can-gold);
    }
    
    .table-custom th {
        padding: 1rem 0.75rem;
        font-weight: 700;
        color: var(--can-gold);
        text-align: center;
        white-space: nowrap;
    }
    
    .table-custom tbody tr {
        background-color: rgba(0, 0, 0, 0.4);
        border-bottom: 1px solid rgba(255,255,255,0.1);
        transition: background-color 0.3s ease;
    }
    
    .table-custom tbody tr:hover {
        background-color: rgba(255,215,0,0.15);
    }
    
    .table-custom td {
        padding: 1rem 0.75rem;
        text-align: center;
        vertical-align: middle;
        color: #e0e0e0;
    }
    
    .table-custom td:first-child {
        text-align: center;
        min-width: 60px;
    }
    
    .table-custom td:nth-child(2) {
        text-align: left;
        min-width: 140px;
        color: #FFD700;
        font-weight: 600;
        font-size: 1.05rem;
    }
    
    .rank-badge {
        display: inline-block;
        background: var(--can-gold);
        color: var(--can-dark);
        padding: 0.35rem 0.7rem;
        border-radius: 50%;
        font-weight: 700;
        font-size: 0.9rem;
        min-width: 45px;
    }
    
    @media (max-width: 768px) {
        .table-custom {
            font-size: 0.85rem;
        }
        
        .table-custom th,
        .table-custom td {
            padding: 0.75rem 0.5rem;
        }
        
        .table-custom td:nth-child(2) {
            min-width: 120px;
        }
    }
</style>

<!-- Header -->
<div class="page-header">
    <div class="container text-center">
        <h1>
            <i class="fas fa-chart-bar"></i>
            Dashboard CAN 2025
        </h1>
        <p class="lead">Statistiques historiques & Indicateurs cl√©s de performance</p>
    </div>
</div>

<div class="container">
    <!-- KPIs Section Principales -->
    <div class="row" id="kpis-container">
        <div class="col-md-3 col-sm-6">
            <div class="kpi-card text-center">
                <div class="kpi-icon"><i class="fas fa-futbol"></i></div>
                <div class="kpi-value" id="kpi-matches">...</div>
                <div class="kpi-label">Total Matches</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="kpi-card text-center">
                <div class="kpi-icon"><i class="fas fa-trophy"></i></div>
                <div class="kpi-value" id="kpi-editions">...</div>
                <div class="kpi-label">√âditions</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="kpi-card text-center">
                <div class="kpi-icon"><i class="fas fa-bullseye"></i></div>
                <div class="kpi-value" id="kpi-goals">...</div>
                <div class="kpi-label">Buts / Match</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="kpi-card text-center">
                <div class="kpi-icon"><i class="fas fa-flag"></i></div>
                <div class="kpi-value" id="kpi-teams">...</div>
                <div class="kpi-label">√âquipes</div>
            </div>
        </div>
    </div>

    <!-- KPIs Suppl√©mentaires -->
    <div class="row mt-3">
        <div class="col-md-3 col-sm-6">
            <div class="kpi-card text-center">
                <div class="kpi-icon"><i class="fas fa-handshake"></i></div>
                <div class="kpi-value" id="kpi-draws">...</div>
                <div class="kpi-label">Matchs Nuls</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="kpi-card text-center">
                <div class="kpi-icon"><i class="fas fa-zap"></i></div>
                <div class="kpi-value" id="kpi-highest-score">...</div>
                <div class="kpi-label">Score Max</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="kpi-card text-center">
                <div class="kpi-icon"><i class="fas fa-users"></i></div>
                <div class="kpi-value" id="kpi-avg-players">...</div>
                <div class="kpi-label">Joueurs/Match</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="kpi-card text-center">
                <div class="kpi-icon"><i class="fas fa-percent"></i></div>
                <div class="kpi-value" id="kpi-home-win-rate">...</div>
                <div class="kpi-label">% Victoires Domicile</div>
            </div>
        </div>
    </div>

    <!-- Champion Card -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="kpi-card text-center" style="background: linear-gradient(135deg, var(--can-gold) 0%, #FFA500 100%);">
                <h3 style="color: var(--can-dark); font-weight: 700;">
                    <i class="fas fa-crown"></i> Champion le plus titr√©
                </h3>
                <div class="kpi-value" id="kpi-champion" style="color: var(--can-dark); font-size: 3rem;">...</div>
                <div class="kpi-label" style="color: var(--can-dark); font-weight: 600; font-size: 1.1rem;">
                    <span id="kpi-champion-titles">0</span> titres
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row mt-4">
        <div class="col-lg-6">
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-chart-line"></i>
                    Historique des Champions
                </h3>
                <canvas id="championsChart"></canvas>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-chart-pie"></i>
                    Distribution des Buts
                </h3>
                <canvas id="goalsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Teams Table -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-ranking-star"></i>
                    Top 15 √âquipes - Statistiques G√©n√©rales
                </h3>
                <div class="table-responsive">
                    <table class="table table-custom" id="teams-table">
                        <thead>
                            <tr>
                                <th style="min-width: 60px;">Rang</th>
                                <th style="min-width: 150px; text-align: left;">√âquipe</th>
                                <th style="min-width: 45px;">J</th>
                                <th style="min-width: 45px;">V</th>
                                <th style="min-width: 45px;">N</th>
                                <th style="min-width: 45px;">D</th>
                                <th style="min-width: 45px;">BP</th>
                                <th style="min-width: 45px;">BC</th>
                                <th style="min-width: 45px;">Pts</th>
                            </tr>
                        </thead>
                        <tbody id="teams-tbody">
                            <tr>
                                <td colspan="9" class="text-center">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Groupes CAN 2025 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-layer-group"></i>
                    Groupes CAN 2025
                </h3>
                <div class="row" id="groups-container">
                    <div class="col-12 text-center">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Configuration Chart.js
Chart.defaults.color = '#fff';
Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

// Charger les KPIs
fetch('/api/kpis')
    .then(response => response.json())
    .then(data => {
        document.getElementById('kpi-matches').textContent = data.total_matches.toLocaleString();
        document.getElementById('kpi-editions').textContent = data.editions;
        document.getElementById('kpi-goals').textContent = data.avg_goals.toFixed(2);
        document.getElementById('kpi-teams').textContent = data.total_teams;
        document.getElementById('kpi-champion').textContent = data.top_champion;
        document.getElementById('kpi-champion-titles').textContent = data.top_champion_titles;
        
        // Nouveaux KPIs
        document.getElementById('kpi-draws').textContent = data.total_draws;
        document.getElementById('kpi-highest-score').textContent = data.highest_score;
        document.getElementById('kpi-avg-players').textContent = data.avg_players;
        document.getElementById('kpi-home-win-rate').textContent = data.home_win_rate.toFixed(1) + '%';
    })
    .catch(error => console.error('Erreur KPIs:', error));

// Charger l'historique des champions
fetch('/api/champions')
    .then(response => response.json())
    .then(data => {
        const champCounts = {};
        data.forEach(item => {
            champCounts[item.Champion] = (champCounts[item.Champion] || 0) + 1;
        });
        
        const sorted = Object.entries(champCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);
        
        const ctx = document.getElementById('championsChart');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sorted.map(item => item[0]),
                datasets: [{
                    label: 'Titres',
                    data: sorted.map(item => item[1]),
                    backgroundColor: 'rgba(255, 215, 0, 0.8)',
                    borderColor: '#FFD700',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    });

// Charger la distribution des buts
fetch('/api/goals_distribution')
    .then(response => response.json())
    .then(data => {
        const goals = Object.keys(data).sort((a, b) => a - b);
        const counts = goals.map(g => data[g]);
        
        const ctx = document.getElementById('goalsChart');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: goals.map(g => g + ' but(s)'),
                datasets: [{
                    data: counts,
                    backgroundColor: [
                        'rgba(255, 215, 0, 0.9)',
                        'rgba(0, 107, 63, 0.9)',
                        'rgba(193, 39, 45, 0.9)',
                        'rgba(255, 165, 0, 0.9)',
                        'rgba(0, 255, 127, 0.9)',
                        'rgba(255, 69, 0, 0.9)'
                    ],
                    borderWidth: 2,
                    borderColor: '#1a1a1a'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: '#fff',
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            }
        });
    });

// Charger le tableau des √©quipes
fetch('/api/team_stats')
    .then(response => response.json())
    .then(data => {
        const tbody = document.getElementById('teams-tbody');
        tbody.innerHTML = '';
        
        data.forEach(team => {
            const row = document.createElement('tr');
            const teamName = team.Team || '-';
            
            row.innerHTML = `
                <td><span class="rank-badge">${team.Rank || '-'}</span></td>
                <td>${teamName}</td>
                <td>${team.Pld || '0'}</td>
                <td style="color: #00ff7f; font-weight: 600;">${team.W || '0'}</td>
                <td style="color: #ffd700; font-weight: 600;">${team.D || '0'}</td>
                <td style="color: #ff6b6b; font-weight: 600;">${team.L || '0'}</td>
                <td>${team.GF || '0'}</td>
                <td>${team.GA || '0'}</td>
                <td><strong style="color: #ffd700;">${team.Pts || '0'}</strong></td>
            `;
            tbody.appendChild(row);
        });
    });

// Charger les groupes
fetch('/api/groups')
    .then(response => response.json())
    .then(groups => {
        const container = document.getElementById('groups-container');
        container.innerHTML = '';
        
        Object.keys(groups).sort().forEach(groupName => {
            const col = document.createElement('div');
            col.className = 'col-lg-4 col-md-6 mb-3';
            
            const teams = groups[groupName];
            const teamsHTML = teams.map(team => 
                `<div style="padding: 0.75rem; background: rgba(255,255,255,0.08); margin: 0.5rem 0; border-radius: 8px; border-left: 3px solid var(--can-gold);">
                    <span style="font-size: 1.5rem; margin-right: 0.5rem;">üè≥Ô∏è</span> 
                    <span style="color: #ffffff; font-weight: 500;">${team}</span>
                </div>`
            ).join('');
            
            col.innerHTML = `
                <div style="background: linear-gradient(135deg, rgba(0,107,63,0.3) 0%, rgba(193,39,45,0.3) 100%); 
                            padding: 1.5rem; border-radius: 10px; border: 2px solid rgba(255,215,0,0.3);">
                    <h4 style="color: var(--can-gold); font-weight: 700; margin-bottom: 1rem; text-align: center;">
                        <i class="fas fa-layer-group"></i> GROUPE ${groupName}
                    </h4>
                    ${teamsHTML}
                </div>
            `;
            
            container.appendChild(col);
        });
    });
</script>
{% endblock %}